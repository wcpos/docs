---
title: "Modello di Gateway"
description: "Crea un gateway di pagamento personalizzato solo per POS per WCPOS"
---

import FeatureCard from '@site/src/components/FeatureCard';
import FeatureGrid from '@site/src/components/FeatureGrid';
import Steps from '@site/src/components/Steps';
import StepCard from '@site/src/components/StepCard';
import Accordion from '@site/src/components/Accordion';
import AccordionItem from '@site/src/components/AccordionItem';

# Modello di Gateway {#gateway-template}

Il Modello di Gateway ti offre un punto di partenza per costruire il tuo gateway di pagamento solo per POS. Produce un plugin WordPress funzionante con un singolo file PHP che puoi installare e personalizzare in base alle tue esigenze.

## Caratteristiche {#features}

<FeatureGrid>
  <FeatureCard icon="code" title="Codice Minimo">
    Un singolo file PHP con solo le essenziali — facile da leggere e modificare
  </FeatureCard>
  <FeatureCard icon="store" title="Solo POS">
    Disabilitato di default nel checkout web, abilitato attraverso le impostazioni WCPOS
  </FeatureCard>
  <FeatureCard icon="terminal" title="Impostazione Automatizzata">
    Uno script shell gestisce la sostituzione dei segnaposto per te
  </FeatureCard>
  <FeatureCard icon="rocket" title="Rilascio su GitHub">
    Fai un bump di versione e GitHub Actions crea un ZIP scaricabile
  </FeatureCard>
</FeatureGrid>

## Introduzione {#getting-started}

<Steps>
  <StepCard number="1" title="Clona il Repository del Modello">

```bash
git clone https://github.com/wcpos/woocommerce-gateway-template.git
cd woocommerce-gateway-template
```

Oppure fai clic sul pulsante **Usa questo modello** nel [repository di GitHub](https://github.com/wcpos/woocommerce-gateway-template) per creare una tua copia.

  </StepCard>
  <StepCard number="2" title="Esegui lo Script di Installazione">

```bash
./create-gateway.sh
```

Lo script richiede alcuni dettagli: il nome del tuo gateway, una breve descrizione e il tuo nome utente GitHub, quindi genera un plugin pronto all'uso in una directory di tua scelta.

  </StepCard>
  <StepCard number="3" title="Installa il Plugin">

Hai due opzioni:

**Opzione A — Copia la cartella direttamente** (se hai accesso al server):
Copia la cartella del gateway generata nella directory `wp-content/plugins/` del tuo sito.

**Opzione B — Zip e carica** (la più semplice per la maggior parte delle persone):
1. Comprimi la cartella generata in un file `.zip`
2. In WordPress, vai a **Plugin > Aggiungi Nuovo > Carica Plugin**
3. Scegli il file zip e fai clic su **Installa Ora**

  </StepCard>
  <StepCard number="4" title="Abilita in WCPOS" isLast>

1. Vai a **WP Admin > WCPOS > Impostazioni > Checkout**
2. Trova il tuo nuovo gateway nell'elenco e abilitalo

:::note
Il gateway è disabilitato di default nel checkout web regolare. WCPOS controlla quali gateway appaiono nel POS tramite le proprie impostazioni.
:::

  </StepCard>
</Steps>

## Configurazione Manuale {#manual-setup}

Se preferisci non utilizzare lo script, puoi sostituire i segnaposto tu stesso. Apri ciascun file in un editor di testo e trova-sostituisci il seguente:

| Segnaposto | Cosa inserire | Esempio |
|---|---|---|
| `{{GATEWAY_NAME}}` | Nome visualizzato del tuo gateway | Pagamento in Contante |
| `{{GATEWAY_SLUG}}` | Un identificatore URL-friendly (minuscolo, trattini) | pagamento-contante |
| `{{GATEWAY_DESCRIPTION}}` | Breve descrizione del gateway | Accetta pagamenti in contante in WCPOS |
| `{{GATEWAY_DEFAULT_DESCRIPTION}}` | Testo mostrato al cassiere al checkout | Paga in contante al punto vendita |
| `{{GITHUB_USERNAME}}` | Il tuo nome utente GitHub | kilbot |
| `{{REPO_NAME}}` | Nome del tuo repository | gateway-pagamento-contante |
| `{{AUTHOR_NAME}}` | Il tuo nome | kilbot |
| `{{GATEWAY_ID}}` | Slug con underscore invece di trattini | pagamento_contante |
| `{{GATEWAY_CLASS_NAME}}` | Ogni parola maiuscola, unita da underscore | Pagamento_Contante |
| `{{GATEWAY_FUNCTION_PREFIX}}` | Stesso come Gateway ID | pagamento_contante |

Quindi rinomina `wcpos-{{GATEWAY_SLUG}}.php` per corrispondere al tuo slug (ad es., `wcpos-pagamento-contante.php`).

:::tip
Lo script di installazione deriva automaticamente `GATEWAY_ID`, `GATEWAY_CLASS_NAME` e `GATEWAY_FUNCTION_PREFIX` dal nome e dallo slug, quindi devi pensare a questi solo quando fai una configurazione manuale.
:::

## Come Funziona {#how-it-works}

Il plugin generato registra una classe di gateway di pagamento WooCommerce. Ecco le cose chiave da sapere:

- **`$this->enabled = 'no'`** — Il gateway è nascosto dal checkout web. WCPOS lo abilita nel POS in base alle tue impostazioni POS.
- **`process_payment()`** — Chiama `$order->payment_complete()`, che segna l'ordine come pagato e gestisce la riduzione delle scorte automaticamente.
- **`init_form_fields()`** — Definisce i campi Titolo e Descrizione che appaiono nelle impostazioni di WooCommerce.

## Personalizzazione del Tuo Gateway {#customising-your-gateway}

### Aggiunta di Campi di Pagamento {#adding-payment-fields}

Se il tuo gateway ha bisogno di input dal cassiere (ad esempio, un numero di riferimento), sovrascrivi il metodo `payment_fields()`:

```php
public function payment_fields() {
    if ( $this->description ) {
        echo wpautop( wptexturize( $this->description ) );
    }

    woocommerce_form_field( 'my_gateway_reference', array(
        'type'        => 'text',
        'label'       => __( 'Reference Number', 'your-text-domain' ),
        'required'    => true,
    ) );
}
```

Puoi quindi leggere il valore inviato in `process_payment()` tramite `$_POST['my_gateway_reference']`. Ricorda di sanitizzare qualsiasi input con `sanitize_text_field()`.

### Modifica del Comportamento di Pagamento {#changing-payment-behaviour}

Il modello predefinito segna gli ordini come pagati immediatamente. Se il tuo flusso di lavoro richiede il pagamento successivo (come una fattura), sostituisci `payment_complete()` con un aggiornamento dello stato:

```php
public function process_payment( $order_id ) {
    $order = wc_get_order( $order_id );

    // Set to pending — the customer will pay later.
    $order->update_status( 'pending', __( 'Awaiting payment', 'your-text-domain' ) );

    // Stock must be reduced manually when not using payment_complete().
    wc_reduce_stock_levels( $order_id );

    return array(
        'result'   => 'success',
        'redirect' => $this->get_return_url( $order ),
    );
}
```

## Apportare Modifiche e Aggiornamenti {#making-changes-and-updating}

Dopo aver installato il tuo gateway, puoi continuare a modificare il file del plugin per regolare la logica di pagamento. Per installare una versione aggiornata:

1. Modifica `wcpos-your-slug.php` nella cartella generata
2. Aggiorna il numero `Version:` nell'intestazione del plugin (ad es., `0.1.0` a `0.2.0`)
3. Zip la cartella e caricala di nuovo tramite **Plugin > Aggiungi Nuovo > Carica Plugin**, oppure sostituisci direttamente la cartella in `wp-content/plugins/`

:::tip
WordPress chiederà se vuoi sostituire il plugin esistente quando carichi uno zip con lo stesso nome del plugin — fai clic su **Sostituisci quello attuale con caricato** per aggiornare.
:::

### Rilascio Automatizzato con GitHub {#automated-releases-with-github}

Se carichi il tuo gateway in un repository GitHub, il modello include un workflow di GitHub Actions che crea rilasci automaticamente:

1. Aggiorna il numero `Version:` nell'intestazione del plugin
2. Effettua un commit e push nel ramo `main`
3. GitHub Actions rileva la modifica della versione e crea un nuovo rilascio con un ZIP scaricabile

Altri utenti possono quindi scaricare il ZIP dalla pagina **Rilasci** del tuo repository e installarlo come qualsiasi plugin WordPress.

## Risoluzione dei Problemi {#troubleshooting}

<Accordion>
  <AccordionItem question="Il gateway non appare nel POS">

  - Controlla che il plugin sia attivato in **WP Admin > Plugin**
  - Vai a **WP Admin > WCPOS > Impostazioni > Checkout** e assicurati che il gateway sia abilitato
  - Verifica che WooCommerce sia installato e attivo

  </AccordionItem>

  <AccordionItem question="Il gateway appare nel checkout web">

  - Assicurati che `$this->enabled = 'no';` sia impostato nel costruttore del gateway
  - WCPOS sovrascrive questa impostazione per le richieste POS, quindi il gateway dovrebbe apparire solo nel POS

  </AccordionItem>

  <AccordionItem question="Gli ordini rimangono in 'In Elaborazione' invece di 'Completati'">

  - WooCommerce imposta lo stato dell'ordine in base ai tipi di prodotto. Gli ordini contenenti prodotti fisici rimangono in "In Elaborazione" — questo è il comportamento normale di WooCommerce. Solo gli ordini con esclusivamente prodotti virtuali o scaricabili sono segnati "Completati" automaticamente.

  </AccordionItem>
</Accordion>

## Risorse {#resources}

- **GitHub**: [woocommerce-gateway-template](https://github.com/wcpos/woocommerce-gateway-template)
- **WooCommerce Payment Gateway API**: [WC_Payment_Gateway docs](https://woocommerce.github.io/code-reference/classes/WC-Payment-Gateway.html)

### Gateways di Esempio {#example-gateways}

Questi gateway esistenti sono stati costruiti con lo stesso approccio e sono buone referenze:

- **[Fattura via Email](./email-invoice)** — Invia un'email di fattura in modo che il cliente possa pagare più tardi
- **[Checkout Web](./web-checkout)** — Reindirizza al negozio online per il pagamento
---
title: 网关模板
description: 创建您自己的自定义WooCommerce POS支付网关
---

import FeatureCard from '@site/src/components/FeatureCard';
import FeatureGrid from '@site/src/components/FeatureGrid';

# 网关模板

WooCommerce网关模板为创建您自己自定义的WooCommerce POS支付网关提供了一个起点。该模板包括构建一个完全功能性支付网关所需的所有基础代码和结构。

## 特性

<FeatureGrid>
  <FeatureCard icon="code" title="完整模板">
    现成可用的网关结构，包含所有必要的方法
  </FeatureCard>
  <FeatureCard icon="store" title="POS集成">
    预配置以兼容WooCommerce POS
  </FeatureCard>
  <FeatureCard icon="terminal" title="自动设置">
    基于脚本的模板定制
  </FeatureCard>
  <FeatureCard icon="puzzle-piece" title="可扩展">
    便于修改和扩展以适应特定支付提供商
  </FeatureCard>
</FeatureGrid>

## 入门指南

### 选项1：自动模板生成

该模板包含一个脚本，可以自动为您的特定网关定制模板：

1. **克隆仓库**：
   ```bash
   git clone https://github.com/wcpos/woocommerce-gateway-template.git
   cd woocommerce-gateway-template
   ```

2. **运行设置脚本**：
   ```bash
   ./create-gateway.sh
   ```

3. **遵循提示**：
   - 输入您的网关名称（如："我的支付网关"）
   - 输入网关slug（如："my-payment"）
   - 提供一个描述
   - 此脚本将生成一个定制化的插件

### 选项2：手动模板使用

如果您倾向于手动定制：

1. **下载模板**：
   - 访问[网关模板仓库](https://github.com/wcpos/woocommerce-gateway-template)
   - 下载最新版本或克隆该仓库

2. **定制模板**：
   - 将`{{GATEWAY_NAME}}`替换为您的网关显示名称
   - 将`{{GATEWAY_SLUG}}`替换为您的网关唯一标识符
   - 将`{{GATEWAY_DESCRIPTION}}`替换为您的网关描述

3. **重命名文件**：
   - 将`wcpos-{{GATEWAY_SLUG}}.php`重命名为与您的网关slug匹配
   - 更新文件头信息和插件信息

## 模板结构

### 主插件文件

主插件文件（`wcpos-{{GATEWAY_SLUG}}.php`）包含：

- **插件头**：WordPress插件信息
- **网关类**：主支付网关类
- **初始化**：插件设置和钩子
- **集成**：WooCommerce POS兼容性

### 关键组件

**网关类结构**：
```php
class WCPOS_Gateway_{{GATEWAY_CLASS}} extends WC_Payment_Gateway {
    // Gateway configuration
    public function __construct() { }
    
    // Admin settings form
    public function init_form_fields() { }
    
    // Process payment (main logic goes here)
    public function process_payment( $order_id ) { }
    
    // POS-specific methods
    public function payment_fields() { }
}
```

## 定制指南

### 基本配置

1. **网关信息**：
   ```php
   $this->id = 'your_gateway_id';
   $this->title = 'Your Gateway Name';
   $this->description = 'Gateway description for customers';
   $this->method_title = 'Admin title';
   $this->method_description = 'Admin description';
   ```

2. **支持的功能**：
   ```php
   $this->supports = array(
       'products',
       'refunds',
       'subscriptions', // if applicable
   );
   ```

### 付款处理

核心支付逻辑位于`process_payment()`方法中：

```php
public function process_payment( $order_id ) {
    $order = wc_get_order( $order_id );
    
    // 在这里添加您的支付处理逻辑
    // 示例：API调用、验证等
    
    if ( $payment_successful ) {
        $order->payment_complete();
        return array(
            'result' => 'success',
            'redirect' => $this->get_return_url( $order )
        );
    } else {
        wc_add_notice( 'Payment failed', 'error' );
        return array(
            'result' => 'failure'
        );
    }
}
```

### 管理设置

在`init_form_fields()`中配置管理设置：

```php
public function init_form_fields() {
    $this->form_fields = array(
        'enabled' => array(
            'title' => 'Enable/Disable',
            'type' => 'checkbox',
            'label' => 'Enable Your Gateway',
            'default' => 'yes'
        ),
        'api_key' => array(
            'title' => 'API Key',
            'type' => 'text',
            'description' => 'Enter your API key',
            'default' => '',
            'desc_tip' => true,
        ),
        // 根据需要添加更多设置
    );
}
```

### POS集成

实现POS特定功能：

```php
public function payment_fields() {
    // 自定义的POS支付表单
    if ( is_admin() && isset( $_GET['page'] ) && $_GET['page'] === 'wc-pos' ) {
        // POS特定的支付字段
        echo '<div class="pos-payment-fields">';
        // 您的自定义POS界面
        echo '</div>';
    } else {
        // 标准网页结账字段
        parent::payment_fields();
    }
}
```

## 开发最佳实践

### 代码标准

- **WordPress编码标准**：遵循WordPress PHP编码标准
- **WooCommerce指南**：遵循WooCommerce开发实践
- **安全性**：对输入进行净化，验证数据，使用nonces
- **国际化**：使用`__()`和`_e()`使字符串可翻译

### 错误处理

```php
// 适当的错误处理
try {
    $result = $this->process_api_call( $data );
    if ( is_wp_error( $result ) ) {
        throw new Exception( $result->get_error_message() );
    }
} catch ( Exception $e ) {
    $order->add_order_note( 'Payment failed: ' . $e->getMessage() );
    wc_add_notice( 'Payment processing error', 'error' );
    return array( 'result' => 'failure' );
}
```

### 日志记录

```php
// 添加日志记录以便于调试
if ( $this->debug ) {
    $this->log( 'Payment processing started for order ' . $order_id );
}

private function log( $message ) {
    if ( empty( $this->logger ) ) {
        $this->logger = wc_get_logger();
    }
    $this->logger->info( $message, array( 'source' => $this->id ) );
}
```

## 测试您的网关

### 开发环境

1. **测试模式**：始终实现测试/沙盒模式
2. **调试日志**：包含详尽的日志以便于故障排查
3. **错误场景**：测试各种失败条件
4. **POS测试**：专门在POS环境中进行测试

### 测试用例

- **成功支付**：验证订单正确完成
- **失败支付**：确保正确的错误处理
- **退款**：如支持，则测试退款功能
- **边缘案例**：测试不同订单金额和配置的情况

## 部署

### 插件打包

1. **删除开发文件**：清除测试文件和开发工具
2. **版本控制**：在插件头中更新版本号
3. **文档**：包含安装说明的README
4. **ZIP包**：创建可安装的zip文件

### 分发

- **GitHub发布**：利用GitHub发布进行版本管理
- **WordPress插件目录**：考虑提交到WordPress.org
- **私有分发**：如有需要，可托管在自己的服务器上

## 高级功能

### Webhooks

用于获取实时支付更新：

```php
public function handle_webhook() {
    $payload = file_get_contents( 'php://input' );
    $data = json_decode( $payload, true );
    
    // 验证webhook签名
    if ( $this->verify_webhook_signature( $payload ) ) {
        $this->process_webhook_data( $data );
    }
}
```

### 订阅支持

对于定期付款：

```php
// 添加订阅支持
$this->supports[] = 'subscriptions';
$this->supports[] = 'subscription_cancellation';
$this->supports[] = 'subscription_suspension';
```

### 多货币

支持国际支付：

```php
public function get_supported_currencies() {
    return array( 'USD', 'EUR', 'GBP', 'CAD' );
}
```

## 资源

### 文档

- [WooCommerce支付网关API](https://woocommerce.github.io/code-reference/classes/WC-Payment-Gateway.html)
- [WordPress插件开发](https://developer.wordpress.org/plugins/)
- [WooCommerce POS文档](https://docs.wcpos.com/)

### 模板仓库

- **GitHub**：[woocommerce-gateway-template](https://github.com/wcpos/woocommerce-gateway-template)
- **问题**：报告模板问题或请求功能
- **贡献**：通过拉取请求提交改进

### 寻求帮助

获取开发支持：
- 访问[GitHub仓库](https://github.com/wcpos/woocommerce-gateway-template)以获取与模板相关的问题
- 查看WooCommerce开发者文档以获取API方面的问题
- 加入WooCommerce开发者社区以获得一般指导

## 示例网关

研究这些现有的自定义网关以获得实现示例：

- **[Stripe Terminal](./stripe-terminal)**：硬件集成示例
- **[SumUp Terminal](./sumup-terminal)**：基于API的终端集成
- **[Email Invoice](./email-invoice)**：简单的基于电子邮件的网关
- **[Web Checkout](./web-checkout)**：网络集成网关
